<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>
    <img src="{{ url_for('video') }}" width="100%">
    <video id="video" autoplay preload="none"></video>
    <br>
    <center>
    <form action="http://192.168.1.38:5000/say" method="get">
        <center>
        <label for="input">Say what?:</label> </center>
        <input type="text" id="input" name="text"> <center>
        </center>
        <button type="submit">Say</button> <h1>
    </form>    <div id="status"></div>
    </h1>
    <button onclick="rebootSystem()"> reboot system</button>
    <button onclick="restartApp()"> restart app</button>
    </center>

    <script>
      //audio stream code
      if (Hls.isSupported()) {
        var video = document.getElementById('video');
        var hls = new Hls();
        hls.loadSource('http://192.168.1.38:8000/stream/stream.m3u8');
        hls.attachMedia(video);
        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          video.play();
        });
      }
      else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = 'http://192.168.1.38:8000/stream.m3u8';
        video.addEventListener('loadedmetadata', function() {
          video.play();
        });
      }
      //end audio stream

//code for video and numbers
function restartApp() {
    getData("restartserver","")
}

function rebootSystem() {
    getData("rebootsystem","");    
}

function getData(call, data){
    var ajaxReq = new XMLHttpRequest();
    ajaxReq.onreadystatechange = function() {
        if (ajaxReq.readyState == XMLHttpRequest.DONE) {
            if (ajaxReq.status == 200) {
                console.log(ajaxReq.responseText);
                document.getElementById("status").innerHTML = ajaxReq.responseText;
            }
            else if (ajaxReq.status == 400){
                console.log("error 400");
            }
            else {
                console.log("unknown error");
            }
        }
    };
    ajaxReq.open("GET", "http://192.168.1.38:8000/"+call+data+"", true);
    ajaxReq.setRequestHeader('Access-Control-Allow-Headers', '*');
    ajaxReq.send();
}
    
    var context;
    window.onload = function() {
     setInterval(function(){
       getData("status","");
     }, 500);
     getData("status","");

     context = new AudioContext();
      context.onstatechange = function() {
        //if you have permissions, the audioContext will transition to 'running' immediately
        if(context.state == 'running') {
          play();
        }
      }
    };

    function play() {
        //ensure the promise is handled here
        var promise = document.getElementById('myaudio').play();
        if (promise !== undefined) {
          promise.then(_ => {
            console.log("playing");
          }).catch(error => {
            // Autoplay was prevented.
          });
        }
    }

    //play after the user interacts with the page
    document.querySelector('button').addEventListener('click', function() {
      context.resume().then(function() {
        play();
      });
    });

  </script>
</body>
</html>
